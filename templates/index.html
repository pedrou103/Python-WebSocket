<html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat em Tempo Real</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <style>
        @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css");
        /* body {
            padding: 16px;
        } */

        .area-messages {
            background-color: #E3E4FB;
            height: 83vh;
        }

        textarea {
            resize: none;
        }

        .button-send {
            width: 50px !important;
            height: 50px !important;
        }

        li span {
            width: 45px;
            height: 45px;
        }
    </style>
</head>

<body class="p-3">
    <div id="typing" class="text-muted fst-italic mb-2"></div>
    <ul id="messages" class="area-messages rounded-3 overflow-y-auto p-3">
    </ul>
    <form id="form" action="" class="d-flex gap-3">
        <textarea id="input" autocomplete="off" rows="3" class="form-control rounded-4 "
            placeholder="Write your message here"></textarea>

        <button type="submit"
            class="btn btn-outline-primary rounded-circle d-flex align-items-center justify-content-center button-send">
            <i class="bi bi-send-fill"></i>
        </button>
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    <script>
        // ======== DEFINIR NOME DO USUÁRIO =========
        let username = prompt("Digite seu nome:");

        if (!username || username.trim() === "") {
            username = "User_" + Math.floor(Math.random() * 10000);
        }

        // ==========================================
        var socket = io.connect('http://' + document.domain + ':' + location.port);

        let lastSender = null;

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // RECEBENDO MENSAGEM
        socket.on('message', function (data) {
            var ul = document.getElementById('messages');

            const safeText = escapeHtml(data.text);
            const isMine = data.user === username;

            const timestamp = new Date(data.timestamp);
            const hour = timestamp.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

            const showAvatar = lastSender !== data.user;
            lastSender = data.user;

            // const showUser = user !== lastUser; // mostrar nome e ícone apenas se mudou de usuário
            // lastUser = user;

            const liClass = isMine ? "justify-content-end" : "justify-content-start";
            const bubbleClass = isMine ? "bg-primary text-white" : "bg-light";

            const avatarHTML = showAvatar
                ? `<span class="bg-dark-subtle text-white rounded-circle shadow d-flex align-items-center justify-content-center">
                    <i class="bi bi-person-circle" style="font-size: 40px;"></i>
               </span>`
                : `<span style="width:45px;height:45px;"></span>`;

            const element = `
            <li class="d-flex ${liClass} align-items-start gap-3 flex-row mb-2">
                
                ${!isMine ? avatarHTML : ''}
                <div class="card p-2 border-0 shadow-sm rounded-3 ${bubbleClass}" style="max-width: 60%;">
                    <div>${safeText}</div>
                    <small class="text-muted" style="font-size: 0.7rem;">${hour}</small>
                </div>
                ${isMine ? avatarHTML : ''}
            </li>
        `;

            ul.insertAdjacentHTML("beforeend", element);
            ul.scrollTop = ul.scrollHeight;
        });

        // ENVIANDO MENSAGEM
        document.getElementById('form').onsubmit = function () {
            socket.emit("message", {
                user: username,
                text: document.getElementById("input").value,
                timestamp: new Date().toISOString()
            });

            document.getElementById('input').value = '';
            return false;
        };

        // INDICADOR DE DIGITAÇÃO
        document.getElementById("input").addEventListener("input", () => {
            socket.emit("typing", username);
        });

        socket.on("typing", function (user) {
            if (user !== username) {
                document.getElementById("typing").innerText = user + " está digitando...";
                setTimeout(() => {
                    document.getElementById("typing").innerText = "";
                }, 1500);
            }
        });

    </script>
</body>

</html>